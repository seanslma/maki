# Kubernetes

## keyvault to aks container
https://medium.com/@bashaus/3-4-configuring-key-vault-to-expose-environment-variables-to-azure-kubernetes-services-48b633ec9e67

To establish a connection between a Key Vault and an AKS container, we need to configure the following resources:
- Azure `Key Vault` (with some keys, secrets or certificates).
- A `servicve principal`using Role-Based Access Control (RBAC).
- A `SecretProviderClass` — a Kubernetes resource (which requires installation) that describes instructions for how keys/secrets/certificates can be pulled from a Key Vault and stored as Secrets.
- A `Secret` — a Kubernetes resource (which comes out of the box) that stores secrets in Kubernetes for use by other resources — it will be automatically generated by the `ServiceProviderClass`.
- A deployment or `pod` to consume the Secret.

## mount secret as env var
```yaml
containers:
  - name: tfs-agent
    env:
      - name: ENV_VAR_K8S_SECRET
        valueFrom:
          secretKeyRef:
            name: k8s_secret
            key: name
```

## mount azure keyvault secret as env var
https://serverfault.com/questions/1075149/aks-with-azure-key-vault-env-variables-dont-load

secrets.yaml
```yaml
apiVersion: secrets-store.csi.x-k8s.io/v1alpha1
kind: SecretProviderClass
metadata:
  name: azure-kv-secrets
  namespace: dev
spec:
  provider: azure
  parameters:
    usePodIdentity: "true"
    keyvaultName: "my-keyvault"                  
    objects:  |
      array:
        - |
          objectName: my-db-user
          objectType: secret
          #ObjectAlias: user.json
          objectVersion: ""
        - |
          objectName: my-db-pass
          objectType: secret
          #ObjectAlias: pass.json
          objectVersion: ""
    tenantId: "<tenantID>"
```
