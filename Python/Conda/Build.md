<!-- {% raw %} -->
# Build

https://docs.conda.io/projects/conda-build/en/latest/concepts/recipe.html

Building a conda package requires a recipe. A conda-build recipe is a flat directory that contains the following files:
- meta.yaml: Only `package/name` and `package/version` are required
- build.sh: It is executed using the bash command for macOS and Linux.
- bld.bat: It is executed using cmd for Windows.
- run_test.[py,pl,sh,bat]: a test script that runs automatically if it is part of the recipe.
- Optional patches that are applied to the source.
- Other resources that are not included in the source and cannot be generated by the build scripts.

## parameters
https://docs.conda.io/projects/conda-build/en/stable/resources/commands/conda-build.html

## build.sh
You can define the `build.sh` script inline in the meta.yaml file otherwise conda-build will look for a `build.sh` script in the recipe directory 
```yaml
build:
  number: 100
  script: "{{ PYTHON }} -m pip install . --no-deps --ignore-installed --no-cache-dir -vvv"
```

## debug
https://docs.conda.io/projects/conda-build/en/stable/user-guide/recipes/debugging.html

debugging is a process of getting into or recreating the environment and set of shell environment variables 
that conda-build creates during its build or test processes.
```sh
conda debug recipe
conda debug recipe --python=3.9 --variants="{blas_impl: 'openblas'}"
cd /debug/path && source /debug/path/build_env_setup.sh
conda build purge-all # remove previously built packages
```

## build conda package
- `--output` will disable all output messages
- `--croot` path cannot be a subfolder of the current folder
  `AssertionError: Can't merge/copy source into subdirectory of itself.  Please create separate spaces for these things.`
```
conda build recipe --no-anaconda-upload --python 3.9 --croot c:/pkg/conda --no-test
conda build recipe --no-anaconda-upload --python 3.9 --croot /build/path --no-test --channel ch1 --channel ch2
```
Note that without set `--python`, will build a package compatible to the python version in the current env. 
We can also set the cli flags via env var `CONDA_PY` and the flag `--variants` which accepts JSON-formatted text.
example: https://docs.conda.io/projects/conda-build/en/latest/resources/variants.html
```sh
conda build recipe --variants "{python: [2.7, 3.5], vc: [9, 14]}"
```

## pass variable value to meta.yaml
before running `conda build`
```
export VERSION=1.0.0
```

## meta.yaml
https://stackoverflow.com/questions/38919840/get-package-version-for-conda-meta-yaml-from-source-file

https://www.underworldcode.org/articles/build-conda-packages/
```
{% set NAME = "pkg" %}
{% set VERSION = load_setup_py_data().version %}
{% set GITHUB_URL = load_setup_py_data().url %}
{% set DESCRIPTION = load_setup_py_data().description %}

package:
  name: {{ NAME }}
  version: {{ VERSION }}

source:
  path: ../

outputs:
  - name: {{ NAME }}
    build:
      number: 0
      script: python -m pip install --no-deps --ignore-installed .
      entry_points:
        - pkg-run = pkg.main:cli
    requirements:
      host:
        - pip
        - python
        - setuptools >=41.0.0
      run:
        - click
        - numba
        - numpy
        - pandas
        - python
    about:
      home: {{ GITHUB_URL }}
      summary: {{ DESCRIPTION }}

  - name: {{ NAME }}.test
    requirements:
      run:
        - pytest
        - pytest-cov
        - coverage
    test:
      source_files:
        - tests
    about:
      home: {{ GITHUB_URL }}
      summary: Test dependencies for {{ NAME }}

  - name: {{ NAME }}.doc
    requirements:
      run:
        - docstring_parser
        - mkdocs
        - mkdocstrings <0.18
        - mkdocs-click
        - mkdocs-material
        - mkdocs-material-extensions
        - pytkdocs
    about:
      home: {{ GITHUB_URL }}
      summary: Doc dependencies for {{ NAME }}
```

<!-- {% endraw %} -->

## issue
https://stackoverflow.com/questions/69030813/doing-a-conda-build-does-not-find-any-files/69044365#69044365
